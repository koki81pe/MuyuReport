<!-- MOD-001: ENCABEZADO [INICIO] -->
<!--
*****************************************
PROYECTO: MuyuReport
ARCHIVO: scripts.html
VERSIÓN: 01.08
FECHA: 19/01/2026 21:48 (UTC-5)
*****************************************
-->
<!-- MOD-001: FIN -->

<!-- MOD-002: CDN CHART.JS [INICIO] -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- MOD-002: FIN -->

<!-- MOD-003: SCRIPT PRINCIPAL [INICIO] -->
<script>

// MOD-003-S01: VARIABLES GLOBALES [INICIO]
let lastSalesData = []; // Datos del último día
let daySalesData = []; // Datos del día seleccionado
let currentDayFilter = 'Todas'; // Filtro activo en "Por día"
let displayedLastSales = 0;
let currentChart = null;

const MONTHS_NAMES = {
  1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril',
  5: 'Mayo', 6: 'Junio', 7: 'Julio', 8: 'Agosto',
  9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'
};
// MOD-003-S01: FIN

// MOD-003-S02: INICIALIZACIÓN [INICIO]
document.addEventListener('DOMContentLoaded', function() {
  initializeTabs();
  initializeSubTabs();
  initializeLastSalesTab();
  initializeDayTab();
  initializeMonthlyTab();
  initializeYearlyTab();
  initializeChartsTab();
  initializeCollapseButtons();
});
// MOD-003-S02: FIN

// MOD-003-S03: SISTEMA PESTAÑAS [INICIO]
function initializeTabs() {
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const targetTab = this.getAttribute('data-tab');
      
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      this.classList.add('active');
      document.getElementById(targetTab).classList.add('active');
    });
  });
}
// MOD-003-S03: FIN

// MOD-003-S04: SISTEMA SUB-PESTAÑAS [INICIO]
function initializeSubTabs() {
  const subTabButtons = document.querySelectorAll('.sub-tab-btn');
  
  subTabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const targetSubTab = this.getAttribute('data-subtab');
      const parentSection = this.closest('section');
      
      const siblings = this.parentElement.querySelectorAll('.sub-tab-btn');
      siblings.forEach(btn => btn.classList.remove('active'));
      
      const contents = parentSection.querySelectorAll('.sub-tab-content');
      contents.forEach(content => content.classList.remove('active'));
      
      this.classList.add('active');
      document.getElementById(targetSubTab).classList.add('active');
    });
  });
}
// MOD-003-S04: FIN

// MOD-003-S05: ÚLTIMAS VENTAS [INICIO]
function initializeLastSalesTab() {
  loadLastSales();
  
  const btnRefresh = document.getElementById('btn-refresh');
  if (btnRefresh) {
    btnRefresh.addEventListener('click', refreshLastSales);
  }
  
  const btnLoadMore = document.getElementById('btn-load-more');
  if (btnLoadMore) {
    btnLoadMore.addEventListener('click', displayMoreLastSales);
  }
}

function loadLastSales() {
  LoaderSystem.show('Cargando últimas ventas...');
  
  google.script.run
    .withSuccessHandler(function(response) {
      LoaderSystem.hide();
      
      if (response.success) {
        lastSalesData = response.data;
        displayedLastSales = 0;
        updateLastDayHeader(response);
        renderLastSalesTable();
      } else {
        ModalSystem.error('No se pudieron cargar las ventas');
      }
    })
    .withFailureHandler(function(error) {
      LoaderSystem.hide();
      ModalSystem.error('Error de conexión con el servidor');
      console.log('Error:', error);
    })
    .getLastRecords();
}

function refreshLastSales() {
  lastSalesData = [];
  displayedLastSales = 0;
  document.getElementById('sales-tbody').innerHTML = '';
  loadLastSales();
}

function updateLastDayHeader(response) {
  const dateEl = document.getElementById('last-day-date-full');
  const amountEl = document.getElementById('last-day-amount');
  const breakdownEl = document.getElementById('last-day-breakdown');
  
  dateEl.textContent = `${response.dayOfWeek} ${response.lastDate}`;
  amountEl.textContent = formatNumber(response.total);
  
  const breakdown = [];
  if (response.breakdown.Yape > 0) breakdown.push(`Yape ${formatNumber(response.breakdown.Yape)}`);
  if (response.breakdown.Efectivo > 0) breakdown.push(`Cash ${formatNumber(response.breakdown.Efectivo)}`);
  if (response.breakdown.Tarjeta > 0) breakdown.push(`Card ${formatNumber(response.breakdown.Tarjeta)}`);
  
  breakdownEl.textContent = breakdown.length > 0 ? ': ' + breakdown.join(' / ') : '';
}

function renderLastSalesTable() {
  const tbody = document.getElementById('sales-tbody');
  const toDisplay = Math.min(displayedLastSales + 10, lastSalesData.length);
  
  if (displayedLastSales === 0) {
    tbody.innerHTML = '';
  }
  
  for (let i = displayedLastSales; i < toDisplay; i++) {
    const sale = lastSalesData[i];
    const row = tbody.insertRow();
    row.classList.add('fade-in');
    
    row.innerHTML = `
      <td>${sale.categoria}</td>
      <td>${sale.producto}</td>
      <td>${sale.medioPago}</td>
      <td>${formatNumber(sale.total)}</td>
    `;
  }
  
  displayedLastSales = toDisplay;
  
  const btnLoadMore = document.getElementById('btn-load-more');
  const noMoreMsg = document.getElementById('no-more-msg');
  
  if (displayedLastSales >= lastSalesData.length) {
    btnLoadMore.classList.add('hidden');
    noMoreMsg.classList.remove('hidden');
  } else {
    btnLoadMore.classList.remove('hidden');
    noMoreMsg.classList.add('hidden');
  }
  
  if (lastSalesData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="4" class="no-data">No hay ventas registradas</td></tr>';
  }
}

function displayMoreLastSales() {
  if (displayedLastSales < lastSalesData.length) {
    renderLastSalesTable();
  }
}
// MOD-003-S05: FIN

// MOD-003-S06: VENTAS POR DÍA [INICIO]
function initializeDayTab() {
  const btnApply = document.getElementById('btn-apply-date');
  if (btnApply) {
    btnApply.addEventListener('click', applyDateFilter);
  }
  
  const filterButtons = document.querySelectorAll('.filter-btn');
  filterButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      filterButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const filter = this.getAttribute('data-filter');
      filterDaySales(filter);
    });
  });
  
  setTimeout(() => applyDateFilter(), 500);
}

function applyDateFilter() {
  const dateInput = document.getElementById('date-input').value;
  
  if (!dateInput || !dateInput.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
    ModalSystem.warning('Ingresa una fecha válida (DD/MM/AAAA)');
    return;
  }
  
  const activeFilter = document.querySelector('.filter-btn.active');
  const medioPago = activeFilter ? activeFilter.getAttribute('data-filter') : 'Todas';
  
  loadDaySales(dateInput, medioPago);
}

function filterDaySales(medioPago) {
  const dateInput = document.getElementById('date-input').value;
  
  if (!dateInput) {
    ModalSystem.warning('Primero selecciona una fecha');
    return;
  }
  
  currentDayFilter = medioPago;
  loadDaySales(dateInput, medioPago);
}

function loadDaySales(fecha, medioPago) {
  LoaderSystem.show('Cargando ventas del día...');
  
  google.script.run
    .withSuccessHandler(function(response) {
      LoaderSystem.hide();
      
      if (response.success) {
        daySalesData = response.data;
        updateDayHeader(response);
        renderDaySalesTable();
      } else {
        ModalSystem.error('No se pudieron cargar las ventas');
      }
    })
    .withFailureHandler(function(error) {
      LoaderSystem.hide();
      ModalSystem.error('Error de conexión con el servidor');
      console.log('Error:', error);
    })
    .getSalesByDay(fecha, medioPago);
}

function updateDayHeader(response) {
  const dateEl = document.getElementById('day-date-full');
  const amountEl = document.getElementById('day-amount');
  const breakdownEl = document.getElementById('day-breakdown');
  
  dateEl.textContent = `${response.dayOfWeek} ${response.fecha}`;
  amountEl.textContent = formatNumber(response.total);
  
  const breakdown = [];
  if (response.breakdown.Yape > 0) breakdown.push(`Yape ${formatNumber(response.breakdown.Yape)}`);
  if (response.breakdown.Efectivo > 0) breakdown.push(`Cash ${formatNumber(response.breakdown.Efectivo)}`);
  if (response.breakdown.Tarjeta > 0) breakdown.push(`Card ${formatNumber(response.breakdown.Tarjeta)}`);
  
  breakdownEl.textContent = breakdown.length > 0 ? ': ' + breakdown.join(' / ') : '';
}

function renderDaySalesTable() {
  const tbody = document.getElementById('day-sales-tbody');
  const thead = document.querySelector('#day-sales-table thead tr');
  
  tbody.innerHTML = '';
  
  if (currentDayFilter === 'Todas') {
    thead.innerHTML = `
      <th>Categoría</th>
      <th>Producto</th>
      <th>Medio</th>
      <th>Monto</th>
    `;
  } else {
    thead.innerHTML = `
      <th>Categoría</th>
      <th>Producto</th>
      <th>Monto</th>
    `;
  }
  
  daySalesData.forEach(sale => {
    const row = tbody.insertRow();
    row.classList.add('fade-in');
    
    if (currentDayFilter === 'Todas') {
      row.innerHTML = `
        <td>${sale.categoria}</td>
        <td>${sale.producto}</td>
        <td>${sale.medioPago || ''}</td>
        <td>${formatNumber(sale.total)}</td>
      `;
    } else {
      row.innerHTML = `
        <td>${sale.categoria}</td>
        <td>${sale.producto}</td>
        <td>${formatNumber(sale.total)}</td>
      `;
    }
  });
  
  const btnLoadMore = document.getElementById('btn-load-more-day');
  btnLoadMore.style.display = 'none';
  
  const colspan = currentDayFilter === 'Todas' ? '4' : '3';
  if (daySalesData.length === 0) {
    tbody.innerHTML = `<tr><td colspan="${colspan}" class="no-data">No hay ventas este día</td></tr>`;
  }
}
// MOD-003-S06: FIN

// MOD-003-S07: RANKING MENSUAL [INICIO]
function initializeMonthlyTab() {
  const btnGenerate = document.getElementById('btn-generate-monthly');
  
  if (btnGenerate) {
    btnGenerate.addEventListener('click', generateMonthlyReport);
  }
}

function generateMonthlyReport() {
  const year = parseInt(document.getElementById('year-input').value);
  const selectedMonths = getSelectedMonths('#ranking-cat');
  
  if (selectedMonths.length === 0) {
    ModalSystem.warning('Selecciona al menos un mes');
    return;
  }
  
  LoaderSystem.show('Generando reporte mensual...');
  
  google.script.run
    .withSuccessHandler(function(response) {
      LoaderSystem.hide();
      
      if (response.success) {
        renderMonthlyRankings(response.data, selectedMonths);
      } else {
        ModalSystem.error('No se pudo generar el reporte');
      }
    })
    .withFailureHandler(function(error) {
      LoaderSystem.hide();
      ModalSystem.error('Error al generar el reporte');
      console.log('Error:', error);
    })
    .getMonthlyData(year, selectedMonths);
}

function renderMonthlyRankings(data, selectedMonths) {
  const container = document.getElementById('monthly-rankings');
  container.innerHTML = '';
  
  selectedMonths.forEach(month => {
    const monthData = data[month];
    
    if (!monthData) return;
    
    const monthDiv = document.createElement('div');
    monthDiv.classList.add('month-ranking', 'fade-in');
    
    let rankingHTML = `
      <div class="month-ranking-header">
        <div class="month-ranking-title">${MONTHS_NAMES[month]}</div>
        <div class="month-ranking-total">
          Total: <strong>${formatNumber(monthData.total)}</strong>
        </div>
      </div>
      <ol class="ranking-list">
    `;
    
    monthData.ranking.forEach(item => {
      const isResto = item.categoria === 'Resto';
      rankingHTML += `
        <li class="ranking-item ${isResto ? 'otros' : ''}">
          <span class="ranking-position">${item.posicion}.</span>
          <span class="ranking-category">${item.categoria}</span>
          <span class="ranking-total">${formatNumber(item.total)}</span>
        </li>
      `;
    });
    
    rankingHTML += '</ol>';
    monthDiv.innerHTML = rankingHTML;
    container.appendChild(monthDiv);
  });
  
  if (selectedMonths.length === 0) {
    container.innerHTML = '<div class="no-data">Selecciona meses para ver el ranking</div>';
  }
}
// MOD-003-S07: FIN

// MOD-003-S08: VENTAS ANUALES [INICIO]
function initializeYearlyTab() {
  const btnGenerate = document.getElementById('btn-generate-yearly');
  
  if (btnGenerate) {
    btnGenerate.addEventListener('click', generateYearlyReport);
  }
}

function generateYearlyReport() {
  const year = parseInt(document.getElementById('year-input-ventas').value);
  
  LoaderSystem.show('Generando reporte anual...');
  
  google.script.run
    .withSuccessHandler(function(response) {
      LoaderSystem.hide();
      
      if (response.success) {
        renderYearlySales(response.data, response.totalYear, year);
      } else {
        ModalSystem.error('No se pudo generar el reporte');
      }
    })
    .withFailureHandler(function(error) {
      LoaderSystem.hide();
      ModalSystem.error('Error al generar el reporte');
      console.log('Error:', error);
    })
    .getYearlySales(year);
}

function renderYearlySales(data, totalYear, year) {
  const tbody = document.getElementById('yearly-sales-tbody');
  tbody.innerHTML = '';
  
  const yearCard = document.getElementById('year-total-card');
  const yearDisplay = document.getElementById('year-display');
  const yearAmount = document.getElementById('year-total-amount');
  
  yearDisplay.textContent = year;
  yearAmount.textContent = formatNumber(totalYear);
  yearCard.classList.remove('hidden');
  
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="no-data">No hay ventas registradas este año</td></tr>';
    return;
  }
  
  data.forEach(monthData => {
    const row = tbody.insertRow();
    row.classList.add('fade-in');
    
    row.innerHTML = `
      <td>${MONTHS_NAMES[monthData.month]}</td>
      <td>${formatNumber(monthData.Yape)}</td>
      <td>${formatNumber(monthData.Efectivo)}</td>
      <td>${formatNumber(monthData.Tarjeta)}</td>
      <td>${formatNumber(monthData.total)}</td>
    `;
  });
}
// MOD-003-S08: FIN

// MOD-003-S09: GRÁFICOS CHART.JS [INICIO]
function initializeChartsTab() {
  const btnGenerate = document.getElementById('btn-generate-chart');
  
  if (btnGenerate) {
    btnGenerate.addEventListener('click', generateChart);
  }
}

function generateChart() {
  const year = parseInt(document.getElementById('chart-year-input').value);
  const selectedMonths = getSelectedMonths('#graficos');
  
  if (selectedMonths.length === 0) {
    ModalSystem.warning('Selecciona al menos un mes');
    return;
  }
  
  LoaderSystem.show('Generando gráfico...');
  
  google.script.run
    .withSuccessHandler(function(response) {
      LoaderSystem.hide();
      
      if (response.success) {
        renderChart(response.data, selectedMonths);
      } else {
        ModalSystem.error('No se pudo generar el gráfico');
      }
    })
    .withFailureHandler(function(error) {
      LoaderSystem.hide();
      ModalSystem.error('Error al generar el gráfico');
      console.log('Error:', error);
    })
    .getChartData(year, selectedMonths);
}

function renderChart(data, selectedMonths) {
  const ctx = document.getElementById('sales-chart').getContext('2d');
  
  if (currentChart) {
    currentChart.destroy();
  }
  
  const datasets = selectedMonths.map((month, index) => {
    const monthData = data[month];
    const color = getColorByIndex(index);
    
    return {
      label: `${MONTHS_NAMES[month]} (${formatNumber(monthData.total)})`,
      data: [
        monthData.weeks.S1,
        monthData.weeks.S2,
        monthData.weeks.S3,
        monthData.weeks.S4
      ],
      borderColor: color,
      backgroundColor: color,
      tension: 0.3,
      pointRadius: 5,
      pointHoverRadius: 7
    };
  });
  
  currentChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['S1 (1-7)', 'S2 (8-14)', 'S3 (15-21)', 'S4 (22-fin)'],
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      aspectRatio: window.innerWidth > 1024 ? 2.5 : 1.5,
      plugins: {
        legend: {
          position: 'top',
          labels: {
            font: {
              size: window.innerWidth > 1024 ? 13 : 11
            },
            padding: 12,
            usePointStyle: true
          }
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label.split('(')[0] + ': ' + formatNumber(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatNumber(value);
            },
            font: {
              size: window.innerWidth > 1024 ? 12 : 10
            }
          }
        },
        x: {
          ticks: {
            font: {
              size: window.innerWidth > 1024 ? 12 : 10
            }
          }
        }
      }
    }
  });
}
// MOD-003-S09: FIN

// MOD-003-S10: BOTONES COLAPSAR [INICIO]
function initializeCollapseButtons() {
  const btnCollapseMonthly = document.getElementById('btn-collapse-monthly');
  const monthSelectorMensual = document.getElementById('month-selector-mensual');
  
  if (btnCollapseMonthly && monthSelectorMensual) {
    btnCollapseMonthly.addEventListener('click', function() {
      toggleCollapse(this, monthSelectorMensual);
    });
  }
  
  const btnCollapseChart = document.getElementById('btn-collapse-chart');
  const monthSelectorGraficos = document.getElementById('month-selector-graficos');
  
  if (btnCollapseChart && monthSelectorGraficos) {
    btnCollapseChart.addEventListener('click', function() {
      toggleCollapse(this, monthSelectorGraficos);
    });
  }
}

function toggleCollapse(button, selector) {
  const isCollapsed = selector.classList.contains('collapsed');
  const icon = button.querySelector('.collapse-icon');
  
  if (isCollapsed) {
    selector.classList.remove('collapsed');
    button.classList.remove('collapsed');
    icon.textContent = '▼';
  } else {
    selector.classList.add('collapsed');
    button.classList.add('collapsed');
    icon.textContent = '▲';
  }
}
// MOD-003-S10: FIN

// MOD-003-S11: FUNCIONES AUXILIARES [INICIO]
function getSelectedMonths(section) {
  const checkboxes = document.querySelectorAll(`${section} .month-check input[type="checkbox"]:checked, ${section} .chart-month:checked`);
  return Array.from(checkboxes).map(cb => parseInt(cb.value));
}

function formatNumber(num) {
  if (num === null || num === undefined) return '0.00';
  return parseFloat(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
}

const COLOR_PALETTE = [
  '#1E90FF', '#FFD700', '#FF0000', '#006400', '#808080', '#000000',
  '#FF00FF', '#FFFF99', '#87CEEB', '#FFC0CB', '#00FF8C', '#FF1493'
];

function getColorByIndex(index) {
  return COLOR_PALETTE[index % COLOR_PALETTE.length];
}
// MOD-003-S11: FIN

// MOD-003-S12: RESIZE HANDLER [INICIO]
window.addEventListener('resize', function() {
  if (currentChart) {
    currentChart.options.aspectRatio = window.innerWidth > 1024 ? 2.5 : 1.5;
    currentChart.update();
  }
});

console.log('MuyuReport scripts.html v01.08 cargado correctamente');
// MOD-003-S12: FIN

</script>
<!-- MOD-003: FIN -->

<!-- MOD-099: NOTAS [INICIO] -->
<!--
DESCRIPCIÓN:
JavaScript frontend completo de MuyuReport v1.08 para dashboard de ventas.

DEPENDENCIAS:
- Backend GAS: getLastRecords(), getSalesByDay(), getMonthlyData(), getYearlySales(), getChartData()
- CDN: Chart.js v4.4.0
- CSS: Clases tab-btn, sub-tab-btn, LoaderSystem, ModalSystem

ADVERTENCIAS:
- MOD-003-S09: Requiere canvas#sales-chart presente en DOM
- 12 submódulos jerárquicos en script principal
- Validaciones preventivas en todas las llamadas GAS

COMPATIBILIDAD:
✔ 100% alineado con CodeWorkShop v5.0
✔ Chart.js v4.4.0 responsive
✔ Mobile-first responsive design
-->
<!-- MOD-099: FIN -->
